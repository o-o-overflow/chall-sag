/*
 * ./calc 0x6B044C73a604b14D735bea5105B7f05B3827a97A 94 24091557
 * 0000000000000000000000006b044c73a604b14d735bea5105b7f05b3827a97a
 * #24091557: 93
 * seed: 0xa59b6f0100000000000000000000000000000000000000000000000000000000
 * max: 0xf8932d44e06dbd318f4e118e0c4297d66ecd3db49274a4616bd05da1e2deeaa8
 */

#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <stdlib.h>

#include "sha3.h"

void hexdump(const void *buffer, size_t size) {
    for (int i = 0; i < size; i++) {
        printf("%02x", ((const uint8_t *)buffer)[i]);
    }
    puts("");
}

static int hexdigit(char ch)
{
    if (ch >= '0' && ch <= '9')
        return  ch - '0';
    if (ch >= 'A' && ch <= 'F')
        return  ch - 'A' + 10;
    if (ch >= 'a' && ch <= 'f')
        return  ch - 'a' + 10;
    return -1;
}

static int hexread(uint8_t *buf, const char *str, int maxbytes)
{
    int i, h, l;

    for (i = 0; i < maxbytes; i++) {
        h = hexdigit(str[2 * i]);
        if (h < 0)
            return i;
        l = hexdigit(str[2 * i + 1]);
        if (l < 0)
            return i;
        buf[i] = (h << 4) + l;
    }

    return i;
}

#define L64_B32(x) (((x & 0xff) << 24) | (((x >> 8) & 0xff) << 16) | (((x >> 16) & 0xff) << 8) | ((x >> 24) & 0xff))

int main(int argc, char *argv[]) {
    if (argc <= 1) {
        printf("usage: %s address [swap limit] [start seed]\n", argv[0]);
        return 1;
    }

    char *p = argv[1];
    if (p[0] == '0' && p[1] == 'x') {
        p += 2;
    }

    int limit = argc >= 3 ? atoi(argv[2]) : 120;
    int seed = argc >= 4 ? atoi(argv[3]) : 0;

    uint64_t mask[4];
    memset(mask, 0, sizeof(mask));
    hexread(&((uint8_t *)mask)[12], p, 20);
    hexdump(mask, 0x20);

    uint64_t tmp[4];
    uint32_t seq[32];

    int best = 32 * 31 / 2;

    for (long long l = seed; ; l++) {
        memset(tmp, 0, sizeof(tmp));
        *(long long *)tmp = l;

        for (int i = 0; i < 32; i++) {
            sha3(tmp, 0x20, tmp, 0x20);
            for (int j = 0; j < 4; j++) {
                tmp[j] ^= mask[j];
            }
            seq[i] = L64_B32(tmp[0]);
        }

        int k = 0;
        for (int i = 0; i < 32; i++) {
            for (int j = i + 1; j < 32; j++) {
                if (seq[i] < seq[j]) {
                    k += 1;
                    uint32_t t = seq[i];
                    seq[i] = seq[j];
                    seq[j] = t;
                }
            }
        }
        if (k < best) {
            printf("#%lld: %d\n", l, k);
            best = k;
        }
        if (k < limit) {
            // run again
            memset(tmp, 0, sizeof(tmp));
            *(long long *)tmp = l;
            printf("seed: 0x");
            hexdump(tmp, 0x20);

            for (int i = 0; i < 32; i++) {
                sha3(tmp, 0x20, tmp, 0x20);
                for (int j = 0; j < 4; j++) {
                    tmp[j] ^= mask[j];
                }
                if (L64_B32(tmp[0]) == seq[0]) {
                    printf("max: 0x");
                    hexdump(tmp, 0x20);
                }
            }
            return 0;
        }
    }
}
